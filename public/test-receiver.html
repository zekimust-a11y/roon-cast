<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Roon Cast - Browser Test</title>
  <style>
    /* Copy all styles from receiver/index.html */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
      position: relative;
    }

    .background-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center bottom;
      background-repeat: no-repeat;
      opacity: 0;
      transition: opacity 1.5s ease-in-out;
      z-index: 0;
    }

    .background-layer.active {
      opacity: 1;
    }

    .background-layer.blurred {
      filter: blur(60px);
      transform: scale(1.2);
    }

    .background-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to bottom, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.7) 100%);
      z-index: 1;
    }

    .bottom-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px 80px;
      gap: 60px;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }

    .bottom-bar.visible {
      opacity: 1;
    }

    .bottom-bar.hidden {
      display: none;
    }

    .artwork-container {
      flex-shrink: 0;
      width: 33vh;
      height: 33vh;
      max-width: 442px;
      max-height: 442px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
    }

    .artwork {
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: opacity 0.4s ease-in-out;
    }

    .artwork.loaded {
      opacity: 1;
    }

    .info {
      flex: 1;
      max-width: 800px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .title {
      font-size: 52px;
      font-weight: 600;
      margin-bottom: 6px;
      line-height: 1.1;
      text-shadow: 0 2px 12px rgba(0, 0, 0, 0.5);
    }

    .artist-text {
      font-size: 36px;
      font-weight: 400;
      color: rgba(255, 255, 255, 0.85);
      margin-bottom: 16px;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
    }

    .progress-row {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 12px;
    }

    .time {
      font-size: 20px;
      font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
      width: 70px;
      font-variant-numeric: tabular-nums;
      color: rgba(255, 255, 255, 0.75);
      display: inline-flex;
      align-items: center;
      line-height: 1;
      min-height: 1em;
    }

    .time.duration {
      justify-content: flex-end;
      text-align: right;
    }

    .progress-container {
      flex: 1;
      height: 3px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 3px;
      position: relative;
      overflow: hidden;
    }

    .progress-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 1) 100%);
      border-radius: 3px;
      transition: width 1s linear;
    }

    #volume-overlay {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.85);
      padding: 40px 60px;
      border-radius: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 100;
      backdrop-filter: blur(20px);
    }

    #volume-overlay.visible {
      opacity: 1;
    }

    .volume-icon {
      font-size: 80px;
    }

    .volume-text {
      font-size: 72px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    .mute-text {
      font-size: 48px;
      color: #ff4444;
    }

    .debug-panel {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.9);
      color: #0f0;
      font-family: monospace;
      font-size: 12px;
      padding: 15px;
      border-radius: 8px;
      max-width: 400px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 200;
      border: 1px solid #333;
    }

    .debug-panel h3 {
      color: #fff;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .debug-panel div {
      margin-bottom: 5px;
    }

    @media (max-width: 1200px) {
      .bottom-bar {
        flex-direction: column;
        gap: 40px;
        padding: 40px;
      }

      .artwork-container {
        width: 55vw;
        height: 55vw;
        max-width: 400px;
        max-height: 400px;
      }

      .title {
        font-size: 36px;
      }

      .artist-text {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <!-- Background layers -->
  <div id="bg-layer-0" class="background-layer active"></div>
  <div id="bg-layer-1" class="background-layer"></div>
  <div class="background-overlay"></div>

  <!-- Now playing UI -->
  <div class="bottom-bar hidden" id="bottom-bar">
    <div class="artwork-container">
      <img id="album-art" class="artwork" alt="Album art" />
    </div>
    <div class="info">
      <h1 class="title"></h1>
      <p class="artist-text"></p>
      <div class="progress-row">
        <span class="time current">0:00</span>
        <div class="progress-container">
          <div class="progress-bar" id="progress-bar"></div>
        </div>
        <span class="time duration">0:00</span>
      </div>
    </div>
  </div>

  <!-- Volume overlay -->
  <div id="volume-overlay">
    <div id="volume-icon" class="volume-icon">ðŸ”Š</div>
    <div id="volume-value" class="volume-text">0</div>
  </div>

  <!-- Debug panel -->
  <div class="debug-panel" id="debug-panel">
    <h3>Debug Info</h3>
    <div id="debug-content"></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Connect to local server via Socket.IO (not Cast API)
    const socket = io();
    
    const BACKGROUND_ROTATION_MS = 20000;
    const bgLayers = [document.getElementById('bg-layer-0'), document.getElementById('bg-layer-1')];
    const titleEl = document.querySelector('.title');
    const artistEl = document.querySelector('.artist-text');
    const currentTimeEl = document.querySelector('.time.current');
    const durationEl = document.querySelector('.time.duration');
    const progressBar = document.getElementById('progress-bar');
    const albumArt = document.getElementById('album-art');
    const bottomBar = document.querySelector('.bottom-bar');
    const volumeOverlay = document.getElementById('volume-overlay');
    const volumeIcon = document.getElementById('volume-icon');
    const volumeValue = document.getElementById('volume-value');
    const debugContent = document.getElementById('debug-content');

    let lastTrackId = '';
    let lastPayload = null;
    let tickTimer = null;
    let activeBackgroundLayer = 0;
    let lastVolume = null;
    let lastMute = null;
    let volumeTimer = null;
    let artistImages = [];
    let rotationTimer = null;

    function debug(msg) {
      const timestamp = new Date().toLocaleTimeString();
      debugContent.innerHTML = `[${timestamp}] ${msg}<br>` + debugContent.innerHTML;
      console.log(`[Test] ${msg}`);
    }

    // Listen for now-playing updates from server
    socket.on('roon:now-playing', (payload) => {
      debug(`Received now-playing: ${payload?.now_playing?.two_line?.line1 || 'unknown'}`);
      applyNowPlaying(payload || {});
    });

    function applyNowPlaying(payload) {
      const state = payload.state || 'idle';
      const isPlaying = state === 'playing';
      const isLoading = state === 'loading';
      const nowPlaying = payload.now_playing || null;

      if (isLoading && !nowPlaying && lastPayload) {
        return;
      }

      if (!nowPlaying && state !== 'idle' && state !== 'stopped' && state !== 'paused' && lastPayload && lastPayload.now_playing) {
        debug('Keeping last display during transition');
        return;
      }

      lastPayload = payload;
      if (tickTimer) clearInterval(tickTimer);

      if (nowPlaying) {
        bottomBar.classList.remove('hidden');
        bottomBar.classList.add('visible');

        const trackId = `${nowPlaying.one_line?.line1 || ''}-${nowPlaying.two_line?.line1 || ''}`;
        let artistName = nowPlaying.two_line?.line2 || '';
        if (artistName.includes(' / ')) {
          artistName = artistName.split(' / ')[0].trim();
        }
        const trackTitle = nowPlaying.two_line?.line1 || nowPlaying.one_line?.line1 || 'Unknown track';
        const duration = nowPlaying.length || 0;
        const seek = payload.seek_position || 0;
        const progress = duration > 0 ? (seek / duration) * 100 : 0;

        titleEl.textContent = trackTitle;
        artistEl.textContent = artistName;
        currentTimeEl.textContent = formatTime(seek);
        durationEl.textContent = formatTime(duration);
        updateProgress(progress);

        if (trackId !== lastTrackId) {
          debug(`Track changed: ${trackTitle} by ${artistName}`);
          lastTrackId = trackId;
          const albumImage = payload.image_data || null;
          const albumBackground = payload.image_url || albumImage;
          const artistImageList = payload.artist_images || [];
          debug(`Artist images received: ${artistImageList.length}`);
          setAlbumArt(albumImage);
          updateBackgroundSources(artistImageList, albumBackground);
        }

        if (tickTimer) {
          clearInterval(tickTimer);
          tickTimer = null;
        }
        if (isPlaying) {
          tickTimer = setInterval(() => incrementSeek(), 1000);
        }
        handleVolumeOverlay(payload.output?.volume);
      } else if (state === 'idle' || state === 'stopped' || state === 'paused') {
        debug(`Resetting display, state: ${state}`);
        resetDisplay();
      }
    }

    function incrementSeek() {
      if (!lastPayload || !lastPayload.now_playing) return;
      if (lastPayload.state && lastPayload.state !== 'playing') {
        return;
      }
      lastPayload.seek_position = (lastPayload.seek_position || 0) + 1;
      const total = lastPayload.now_playing.length || 0;
      const seek = lastPayload.seek_position;
      currentTimeEl.textContent = formatTime(seek);
      const nextProgress = total > 0 ? ((seek + 1) / total) * 100 : 0;
      updateProgress(nextProgress);
    }

    function handleVolumeOverlay(volumeObj) {
      if (!volumeObj) return;
      const db = typeof volumeObj.value === 'number' ? volumeObj.value : -80;
      const percentage = Math.max(0, Math.min(100, Math.round(((db + 80) / 80) * 100)));
      const isMuted = !!volumeObj.is_muted;
      
      const volumeChanged = lastVolume !== null && (lastVolume !== percentage || lastMute !== isMuted);
      
      if (!volumeChanged && lastVolume === null) {
        lastVolume = percentage;
        lastMute = isMuted;
        return;
      }
      
      if (!volumeChanged) return;
      
      lastVolume = percentage;
      lastMute = isMuted;

      if (isMuted) {
        volumeIcon.textContent = 'ðŸ”‡';
        volumeValue.innerHTML = '<span class="mute-text">MUTED</span>';
        volumeOverlay.classList.add('visible');
        clearTimeout(volumeTimer);
      } else {
        volumeIcon.textContent = percentage > 60 ? 'ðŸ”Š' : percentage > 0 ? 'ðŸ”‰' : 'ðŸ”ˆ';
        volumeValue.textContent = percentage;
        volumeOverlay.classList.add('visible');
        clearTimeout(volumeTimer);
        volumeTimer = setTimeout(() => volumeOverlay.classList.remove('visible'), 2500);
      }
    }

    function setAlbumArt(imageUrl) {
      if (imageUrl) {
        const img = new Image();
        img.onload = () => {
          albumArt.src = imageUrl;
          albumArt.classList.add('loaded');
        };
        img.onerror = () => debug('Album art failed to load');
        img.src = imageUrl;
      } else {
        albumArt.classList.remove('loaded');
        albumArt.removeAttribute('src');
      }
    }

    function updateBackgroundSources(artistList, albumImage) {
      if (rotationTimer) {
        clearInterval(rotationTimer);
        rotationTimer = null;
      }
      artistImages = Array.isArray(artistList) ? artistList.filter(Boolean) : [];
      debug(`updateBackgroundSources: ${artistImages.length} artist images`);

      if (artistImages.length > 0) {
        let index = 0;
        const showNext = () => {
          debug(`Showing artist image ${index + 1} of ${artistImages.length}`);
          setBackground(artistImages[index], false);
          index = (index + 1) % artistImages.length;
        };
        showNext();
        if (artistImages.length > 1) {
          rotationTimer = setInterval(showNext, BACKGROUND_ROTATION_MS);
          debug(`Rotation timer set for ${BACKGROUND_ROTATION_MS}ms`);
        }
      } else if (albumImage) {
        debug('No artist images, using blurred album art');
        setBackground(albumImage, true);
      } else {
        debug('No background images available');
        clearBackground();
      }
    }

    function setBackground(url, blurred = false) {
      const target = bgLayers[activeBackgroundLayer === 0 ? 1 : 0];
      const other = bgLayers[activeBackgroundLayer];
      const img = new Image();
      img.onload = () => {
        target.style.backgroundImage = `url('${url}')`;
        if (blurred) {
          target.classList.add('blurred');
        } else {
          target.classList.remove('blurred');
        }
        other.classList.remove('active');
        target.classList.add('active');
        activeBackgroundLayer = activeBackgroundLayer === 0 ? 1 : 0;
      };
      img.onerror = () => {
        debug(`Background image failed: ${url.substring(0, 50)}...`);
        if (!blurred && lastPayload?.image_url) {
          setBackground(lastPayload.image_url, true);
        } else {
          clearBackground();
        }
      };
      img.src = url;
    }

    function clearBackground() {
      bgLayers.forEach(layer => {
        layer.style.backgroundImage = 'none';
        layer.classList.remove('active', 'blurred');
      });
    }

    function updateProgress(progress) {
      progressBar.style.width = `${Math.min(100, Math.max(0, progress))}%`;
    }

    function formatTime(seconds) {
      const safe = Math.max(0, Math.floor(seconds || 0));
      const mins = Math.floor(safe / 60).toString().padStart(1, '0');
      const secs = Math.floor(safe % 60).toString().padStart(2, '0');
      return `${mins}:${secs}`;
    }

    function resetDisplay() {
      bottomBar.classList.add('hidden');
      bottomBar.classList.remove('visible');
      titleEl.textContent = '';
      artistEl.textContent = '';
      currentTimeEl.textContent = '0:00';
      durationEl.textContent = '0:00';
      albumArt.classList.remove('loaded');
      albumArt.removeAttribute('src');
      updateBackgroundSources([], null);
      updateProgress(0);
      stopPlayback();
    }

    function stopPlayback() {
      if (tickTimer) {
        clearInterval(tickTimer);
        tickTimer = null;
      }
      if (rotationTimer) {
        clearInterval(rotationTimer);
        rotationTimer = null;
      }
      lastPayload = null;
    }

    debug('Test receiver initialized - play music in Roon!');
  </script>
</body>
</html>

